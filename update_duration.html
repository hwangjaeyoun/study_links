<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>⚙️ 데이터 일괄 업데이트 도구</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>
    <div style="padding: 20px; font-family: sans-serif;">
        <h1>재생 시간 일괄 업데이트</h1>
        <p>유튜브 API를 사용하여 기존 데이터의 재생 시간을 자동으로 채웁니다.</p>
        <button id="start-btn" style="padding: 15px 30px; font-size: 1.2rem; cursor: pointer;">업데이트 시작하기</button>
        <div id="status-log" style="margin-top: 20px; background: #f1f1f1; padding: 15px; border-radius: 10px; min-height: 200px; white-space: pre-wrap;"></div>
    </div>

<script>
    // 기존 설정 그대로 사용
    const firebaseConfig = {
        apiKey: "AIzaSyAHvOrb4B3c1uY7WwaR1yuQrwP5lDbRZiI",
        databaseURL: "https://linkmanage-d8efd-default-rtdb.firebaseio.com",
        projectId: "linkmanage-d8efd"
    };
    const YOUTUBE_API_KEY = "AIzaSyCSKPPjEy4LIMV289ivkCom8zKwgcUO2ng";

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const logArea = document.getElementById('status-log');

    function addLog(msg) {
        logArea.innerText += msg + "\n";
        console.log(msg);
    }

    document.getElementById('start-btn').onclick = async function() {
        this.disabled = true;
        addLog("🚀 업데이트 프로세스 시작...");

        const snap = await db.ref('class_links').once('value');
        const data = snap.val();
        
        if (!data) {
            addLog("❌ 업데이트할 데이터가 없습니다.");
            return;
        }

        const keys = Object.keys(data);
        let count = 0;

        for (const key of keys) {
            const item = data[key];
            
            // 이미 duration이 있거나 유튜브 링크가 아니면 스킵
            if (item.duration && item.duration !== '-') continue;
            
            const videoId = extractVideoId(item.url);
            if (!videoId) continue;

            addLog(`🔍 [${item.title}] 정보 찾는 중...`);
            
            try {
                const duration = await fetchYouTubeDuration(videoId);
                if (duration) {
                    await db.ref('class_links/' + key).update({ duration: duration });
                    addLog(`✅ 업데이트 성공: ${duration}`);
                    count++;
                }
            } catch (e) {
                addLog(`⚠️ 실패: ${item.title} (${e.message})`);
            }
            
            // API 할당량 보호를 위한 아주 짧은 대기 (선택사항)
            await new Promise(r => setTimeout(r, 200));
        }

        addLog(`\n🎉 모든 작업 완료! 총 ${count}개의 항목이 업데이트되었습니다.`);
    };

    function extractVideoId(url) {
        const regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
        const match = url.match(regExp);
        return (match && match[7].length == 11) ? match[7] : false;
    }

    async function fetchYouTubeDuration(videoId) {
        const apiUrl = `https://www.googleapis.com/youtube/v3/videos?id=${videoId}&key=${YOUTUBE_API_KEY}&part=contentDetails`;
        const res = await fetch(apiUrl);
        const json = await res.json();
        if (json.items && json.items.length > 0) {
            return parseDuration(json.items[0].contentDetails.duration);
        }
        return null;
    }

    function parseDuration(duration) {
        const match = duration.match(/PT(\d+H)?(\d+M)?(\d+S)?/);
        const hours = (parseInt(match[1]) || 0);
        const minutes = (parseInt(match[2]) || 0);
        const seconds = (parseInt(match[3]) || 0);
        let result = "";
        if (hours > 0) result += hours + ":";
        result += (minutes < 10 && hours > 0 ? "0" + minutes : minutes) + ":";
        result += (seconds < 10 ? "0" + seconds : seconds);
        return result;
    }
</script>
</body>
</html>
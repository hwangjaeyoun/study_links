<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ğŸ’» ìˆ˜ì—… ê´€ë¦¬</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        :root { --primary: #60a5fa; --bg: #f0f9ff; }
        body { font-family: 'Pretendard', sans-serif; background: var(--bg); padding: 40px; margin: 0; }
        .container { max-width: 1100px; margin: 0 auto; background: white; padding: 30px; border-radius: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .header-area { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .nav-btns { display: flex; gap: 10px; }
        .reg-btn { padding: 10px 20px; background: var(--primary); color: white; text-decoration: none; border-radius: 10px; font-weight: bold; }
        select { padding: 10px; border-radius: 10px; border: 1px solid #ddd; }
        table { width: 100%; border-collapse: separate; border-spacing: 0 10px; }
        th { background: #f8fafc; padding: 15px; color: #64748b; font-size: 0.9rem; border-bottom: 2px solid #f1f5f9; }
        td { padding: 15px; text-align: center; background: #fff; border-bottom: 1px solid #f1f5f9; }
        .video-link { background: #2563eb; color: white; padding: 7px 15px; border-radius: 8px; text-decoration: none; font-size: 0.85rem; }
        .btn-mini { border: none; background: #f1f5f9; padding: 5px 10px; border-radius: 5px; cursor: pointer; color: #64748b; }
        .done { opacity: 0.5; }
    </style>
</head>
<body>
<div class="container">
    <div class="header-area">
        <h1>ğŸ’» ìˆ˜ì—… ëª©ë¡ </h1>
        <div class="nav-btns">
            <select id="user-filter" onchange="renderLinks(allDataCache)">
                <option value="ì „ì²´">ì „ì²´ ë³´ê¸°</option>
                <option value="í™©ë‹¤ì—°">í™©ë‹¤ì—°</option>
                <option value="ê¹€ë³´ì„">ê¹€ë³´ì„</option>
            </select>
            <a href="admin.html" class="reg-btn">+ ìˆ˜ì—… ë“±ë¡í•˜ê¸°</a>
        </div>
    </div>
    <table>
        <thead>
            <tr>
                <th style="width:100px;">ì´ë¦„</th><th style="width:120px;">ë‚ ì§œ</th><th>ì œëª©</th>
                <th style="width:120px;">ì˜ìƒ</th><th style="width:80px;">ì™„ë£Œ</th><th style="width:120px;">ì‹œê°„</th><th style="width:120px;">ê´€ë¦¬</th>
            </tr>
        </thead>
        <tbody id="pc-table-body"></tbody>
    </table>
</div>
<script>
    const firebaseConfig = {
  apiKey: "AIzaSyAHvOrb4B3c1uY7WwaR1yuQrwP5lDbRZiI",
  authDomain: "linkmanage-d8efd.firebaseapp.com",
  databaseURL: "https://linkmanage-d8efd-default-rtdb.firebaseio.com",
  projectId: "linkmanage-d8efd",
  storageBucket: "linkmanage-d8efd.firebasestorage.app",
  messagingSenderId: "517672204798",
  appId: "1:517672204798:web:ec8315e84a5120648868af",
  measurementId: "G-6J7VGJ2CXM"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let allDataCache = null;
    let editId = null;

    db.ref('class_links').on('value', (snap) => { allDataCache = snap.val(); renderLinks(allDataCache); });

    function toggleCheck(id, currentStatus) {
        const now = new Date();
        const timeStr = !currentStatus ? `${now.getMonth()+1}/${now.getDate()} ${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')}` : '-';
        db.ref('class_links/' + id).update({ checked: !currentStatus, doneTime: timeStr });
    }

    function startEdit(id) { editId = id; renderLinks(allDataCache); }

function saveEdit(id) {
        const tr = document.getElementById(`row-${id}`);
        const updateData = {
            date: tr.querySelector('.ed-date').value,
            title: tr.querySelector('.ed-title').value,
            url: tr.querySelector('.ed-url').value
        };

        // 1. ë°ì´í„° ì—…ë°ì´íŠ¸
        db.ref('class_links/' + id).update(updateData)
        .then(() => {
            editId = null; // ìˆ˜ì • ëª¨ë“œ ì¢…ë£Œ
            // 2. ì„œë²„ì—ì„œ ìµœì‹  ë°ì´í„°ë¥¼ í•œ ë²ˆ ë” ê°€ì ¸ì™€ì„œ (once) ì¬ì¡°íšŒ ë³´ì¥
            return db.ref('class_links').once('value');
        })
        .then((snapshot) => {
            allDataCache = snapshot.val();
            renderLinks(allDataCache); // ìµœì‹  ë°ì´í„°ë¡œ í™”ë©´ ê°±ì‹ 
            console.log("PC ë°ì´í„° ìˆ˜ì • ë° ì¬ì¡°íšŒ ì™„ë£Œ");
        })
        .catch(err => alert("ì €ì¥ ì‹¤íŒ¨: " + err.message));
    }
    function deleteLink(id) { if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) db.ref('class_links/' + id).remove(); }

    function renderLinks(data) {
        const tbody = document.getElementById('pc-table-body');
        const filter = document.getElementById('user-filter').value;
        tbody.innerHTML = '';
        if(!data) return;
        Object.values(data).sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(link => {
            if (filter !== "ì „ì²´" && link.user !== filter) return;
            const tr = document.createElement('tr');
            if(link.checked) tr.className = 'done';
            if(editId === link.id) {
                tr.id = `row-${link.id}`;
                tr.innerHTML = `<td>${link.user}</td><td><input type="date" class="ed-date" value="${link.date}"></td><td><input type="text" class="ed-title" value="${link.title}"></td><td><input type="text" class="ed-url" value="${link.url}"></td><td colspan="2">ìˆ˜ì • ì¤‘</td><td><button onclick="saveEdit('${link.id}')" class="btn-mini" style="background:#bbf7d0;">ì €ì¥</button></td>`;
            } else {
                tr.innerHTML = `<td>${link.user}</td><td>${link.date}</td><td><strong>${link.title}</strong></td><td><a href="${link.url}" target="_blank" class="video-link">ì˜ìƒë³´ê¸°</a></td><td><input type="checkbox" ${link.checked?'checked':''} onchange="toggleCheck('${link.id}',${link.checked})"></td><td>${link.doneTime}</td><td><button onclick="startEdit('${link.id}')" class="btn-mini">ìˆ˜ì •</button> <button onclick="deleteLink('${link.id}')" class="btn-mini">ì‚­ì œ</button></td>`;
            }
            tbody.appendChild(tr);
        });
    }
</script>
</body>
</html>
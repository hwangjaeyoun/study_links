<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ§¸ ìˆ˜ì—… í†µí•© ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        :root { --primary: #60a5fa; --bg: #f0f9ff; --text: #444; }
        body { font-family: 'Pretendard', sans-serif; background-color: var(--bg); margin: 0; padding: 20px; color: var(--text); }
        .container { width: 100%; max-width: 1200px; margin: 0 auto; }
        h1 { text-align: center; color: var(--primary); margin-bottom: 25px; }

        /* ì…ë ¥ ë° í•„í„° íŒ¨ë„ */
        .panel { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-bottom: 25px; }
        .input-group { display: flex; gap: 10px; flex-wrap: wrap; }
        select, input { padding: 12px; border: 2px solid #e0f2fe; border-radius: 12px; font-size: 16px; outline: none; flex: 1; min-width: 120px; }
        .add-btn { padding: 12px 25px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; }

        /* --- [PC ë²„ì „ ìŠ¤íƒ€ì¼] --- */
        .pc-view { display: block; width: 100%; overflow-x: auto; }
        table { width: 100%; border-collapse: separate; border-spacing: 0 10px; table-layout: fixed; }
        th { background: var(--primary); color: white; padding: 15px; font-size: 0.95rem; }
        td { background: white; padding: 12px; text-align: center; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); word-break: break-all; }
        
        /* PC í…Œì´ë¸” ì»¬ëŸ¼ ë„ˆë¹„ ì¡°ì • */
        .col-user { width: 80px; }
        .col-date { width: 110px; }
        .col-title { width: auto; }
        .col-link { width: 100px; }
        .col-check { width: 50px; } /* ì™„ë£Œ ì²´í¬ë°•ìŠ¤ ì‚¬ì´ì¦ˆ ìµœì†Œí™” */
        .col-time { width: 120px; }
        .col-admin { width: 130px; }

        .pc-video-btn { background: #2563eb; color: white; padding: 8px 12px; border-radius: 8px; text-decoration: none; font-size: 0.85rem; display: inline-block; }
        .edit-input-pc { width: 90%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; }

        /* --- [ëª¨ë°”ì¼ ë²„ì „ ìŠ¤íƒ€ì¼] --- */
        .mobile-view { display: none; }
        .link-card { background: white; padding: 18px; border-radius: 20px; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); display: flex; flex-direction: column; gap: 10px; }
        .card-header { display: flex; justify-content: space-between; align-items: center; }
        .user-tag { background: #dcfce7; color: #166534; padding: 4px 10px; border-radius: 8px; font-size: 0.8rem; font-weight: bold; }
        .admin-btns { display: flex; gap: 8px; }
        .btn-mini { padding: 5px 10px; font-size: 0.75rem; border-radius: 6px; border: none; background: #f1f5f9; color: #64748b; cursor: pointer; }
        .btn-save { background: #bbf7d0; color: #166534; font-weight: bold; }
        .video-btn-container { display: flex; align-items: center; gap: 12px; margin-top: 5px; }
        .mobile-video-btn { flex: 1; text-align: center; background: #2563eb; color: white; padding: 15px; border-radius: 15px; text-decoration: none; font-weight: bold; font-size: 1.1rem; }

        /* ê³µí†µ íš¨ê³¼ */
        .done { opacity: 0.6; }
        .done td { color: #94a3b8; }
        .done .title-text { text-decoration: line-through; }
        input[type="checkbox"] { width: 25px; height: 25px; accent-color: #2563eb; cursor: pointer; }

        /* --- [ë°˜ì‘í˜• í•µì‹¬: ë¯¸ë””ì–´ ì¿¼ë¦¬] --- */
        @media screen and (max-width: 768px) {
            .pc-view { display: none; }
            .mobile-view { display: block; }
            .input-group { flex-direction: column; }
            .add-btn { width: 100%; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>â˜ï¸ ìˆ˜ì—… í†µí•© ê´€ë¦¬ì</h1>

    <div class="panel">
        <div class="input-group">
            <select id="user-filter" onchange="renderLinks(allDataCache)" style="background: #f8fafc; border-color: #cbd5e1; flex: 0.5;">
                <option value="ì „ì²´">ì „ì²´ ë³´ê¸°</option>
                <option value="í™©ë‹¤ì—°">í™©ë‹¤ì—°</option>
                <option value="ê¹€ë³´ì„">ê¹€ë³´ì„</option>
            </select>
            <select id="new-user"><option value="">ì´ë¦„</option><option value="í™©ë‹¤ì—°">í™©ë‹¤ì—°</option><option value="ê¹€ë³´ì„">ê¹€ë³´ì„</option></select>
            <input type="date" id="new-date">
            <input type="text" id="new-title" placeholder="ìˆ˜ì—… ì œëª©">
            <input type="text" id="new-url" placeholder="URL ì£¼ì†Œ">
            <button class="add-btn" onclick="addLink()">ê¸°ë¡í•˜ê¸°</button>
        </div>
    </div>

    <div class="pc-view">
        <table>
            <thead>
                <tr>
                    <th class="col-user">ì´ë¦„</th>
                    <th class="col-date">ë‚ ì§œ</th>
                    <th class="col-title">ìˆ˜ì—…ì œëª©</th>
                    <th class="col-link">ë§í¬</th>
                    <th class="col-check">ì™„ë£Œ</th>
                    <th class="col-time">ì™„ë£Œì‹œê°„</th>
                    <th class="col-admin">ê´€ë¦¬</th>
                </tr>
            </thead>
            <tbody id="pc-table-body"></tbody>
        </table>
    </div>

    <div class="mobile-view" id="mobile-card-container"></div>
</div>

<script>
    // Firebase ì„¤ì • (ê¸°ì¡´ ì •ë³´ ë™ì¼)
    const firebaseConfig = {
        apiKey: "AIzaSyAHvOrb4B3c1uY7WwaR1yuQrwP5lDbRZiI",
        authDomain: "linkmanage-d8efd.firebaseapp.com",
        databaseURL: "https://linkmanage-d8efd-default-rtdb.firebaseio.com",
        projectId: "linkmanage-d8efd",
        storageBucket: "linkmanage-d8efd.firebasestorage.app",
        messagingSenderId: "517672204798",
        appId: "1:517672204798:web:ec8315e84a5120648868af",
        measurementId: "G-6J7VGJ2CXM"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let allDataCache = null;
    let editId = null;

    db.ref('class_links').on('value', (snapshot) => {
        allDataCache = snapshot.val();
        renderLinks(allDataCache); 
    });

    function addLink() {
        const user = document.getElementById('new-user').value;
        const date = document.getElementById('new-date').value;
        const title = document.getElementById('new-title').value;
        const url = document.getElementById('new-url').value;
        if (!user || !date || !title || !url) { alert("ë¹ˆì¹¸ì„ ì±„ì›Œì£¼ì„¸ìš”!"); return; }

        const newRef = db.ref('class_links').push();
        newRef.set({ id: newRef.key, user, date, title, url, checked: false, doneTime: '-' })
        .then(() => {
            document.getElementById('new-title').value = '';
            document.getElementById('new-url').value = '';
        });
    }

    function toggleCheck(id, currentStatus) {
        const now = new Date();
        const timeStr = !currentStatus ? `${now.getMonth()+1}/${now.getDate()} ${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')}` : '-';
        db.ref('class_links/' + id).update({ checked: !currentStatus, doneTime: timeStr });
    }

    function startEdit(id) { editId = id; renderLinks(allDataCache); }

function saveEdit(id, type) {
        const container = (type === 'pc') ? document.querySelector(`#pc-row-${id}`) : document.querySelector(`#mob-card-${id}`);
        
        const updateData = {
            date: container.querySelector('.edit-date').value,
            title: container.querySelector('.edit-title').value,
            url: container.querySelector('.edit-url').value
        };

        // 1. Firebase ë°ì´í„° ì—…ë°ì´íŠ¸
        db.ref('class_links/' + id).update(updateData)
        .then(() => {
            editId = null; // ìˆ˜ì • ëª¨ë“œ í•´ì œ
            
            // 2. ëª…ì‹œì ìœ¼ë¡œ ì „ì²´ ë°ì´í„°ë¥¼ í•œ ë²ˆ ë” ê°€ì ¸ì™€ì„œ ìºì‹œ ê°±ì‹  (ì¬ì¡°íšŒ ê°•ì œí™”)
            return db.ref('class_links').once('value');
        })
        .then((snapshot) => {
            allDataCache = snapshot.val(); // ìµœì‹  ë°ì´í„°ë¡œ ìºì‹œ êµì²´
            renderLinks(allDataCache);     // í™”ë©´ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
            console.log("ë°ì´í„° ìˆ˜ì • ë° ì¬ì¡°íšŒ ì™„ë£Œ âœ¨");
        })
        .catch((error) => {
            alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
        });
    }
    function deleteLink(id) {
        if(confirm("ì •ë§ ì‚­ì œí• ê¹Œìš”?")) { db.ref('class_links/' + id).remove(); }
    }

    function renderLinks(data) {
        const pcTbody = document.getElementById('pc-table-body');
        const mobileContainer = document.getElementById('mobile-card-container');
        const filter = document.getElementById('user-filter').value;
        pcTbody.innerHTML = ''; mobileContainer.innerHTML = '';
        if(!data) return;

        Object.values(data).sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(link => {
            if (filter !== "ì „ì²´" && link.user !== filter) return;

            // --- PC ë Œë”ë§ ---
            const tr = document.createElement('tr');
            tr.id = `pc-row-${link.id}`;
            if(link.checked) tr.className = 'done';
            
            if(editId === link.id) {
                tr.innerHTML = `
                    <td>${link.user}</td>
                    <td><input type="date" class="edit-date edit-input-pc" value="${link.date}"></td>
                    <td><input type="text" class="edit-title edit-input-pc" value="${link.title}"></td>
                    <td><input type="text" class="edit-url edit-input-pc" value="${link.url}"></td>
                    <td colspan="2">ìˆ˜ì • ì¤‘...</td>
                    <td><button class="btn-mini btn-save" onclick="saveEdit('${link.id}', 'pc')">ì €ì¥</button></td>
                `;
            } else {
                tr.innerHTML = `
                    <td><span class="user-tag">${link.user}</span></td>
                    <td>${link.date}</td>
                    <td class="title-text"><strong>${link.title}</strong></td>
                    <td><a href="${link.url}" target="_blank" class="pc-video-btn">ì˜ìƒë³´ê¸°</a></td>
                    <td><input type="checkbox" ${link.checked ? 'checked' : ''} onchange="toggleCheck('${link.id}', ${link.checked})"></td>
                    <td style="font-size:0.8rem; color:#888;">${link.doneTime}</td>
                    <td>
                        <button class="btn-mini" onclick="startEdit('${link.id}')">ìˆ˜ì •</button>
                        <button class="btn-mini" onclick="deleteLink('${link.id}')">ì‚­ì œ</button>
                    </td>
                `;
            }
            pcTbody.appendChild(tr);

            // --- ëª¨ë°”ì¼ ë Œë”ë§ ---
            const div = document.createElement('div');
            div.id = `mob-card-${link.id}`;
            div.className = `link-card ${link.checked ? 'done' : ''}`;
            
            if(editId === link.id) {
                div.innerHTML = `
                    <input type="text" class="edit-title" value="${link.title}" style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;">
                    <input type="date" class="edit-date" value="${link.date}" style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;">
                    <input type="text" class="edit-url" value="${link.url}" style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;">
                    <button class="add-btn" onclick="saveEdit('${link.id}', 'mob')">ìˆ˜ì • ì™„ë£Œ</button>
                `;
            } else {
                div.innerHTML = `
                    <div class="card-header">
                        <span class="user-tag">${link.user}</span>
                        <div class="admin-btns">
                            <button class="btn-mini" onclick="startEdit('${link.id}')">ìˆ˜ì •</button>
                            <button class="btn-mini" onclick="deleteLink('${link.id}')">ì‚­ì œ</button>
                        </div>
                    </div>
                    <div class="title-text" style="font-weight:bold; font-size:1.1rem;">${link.title}</div>
                    <div style="font-size:0.85rem; color:#888;">ğŸ“… ${link.date} ${link.checked ? ` | âœ… ${link.doneTime}` : ''}</div>
                    <div class="video-btn-container">
                        <input type="checkbox" ${link.checked ? 'checked' : ''} onchange="toggleCheck('${link.id}', ${link.checked})">
                        <a href="${link.url}" target="_blank" class="mobile-video-btn">â–¶ ì˜ìƒ ë°”ë¡œë³´ê¸°</a>
                    </div>
                `;
            }
            mobileContainer.appendChild(div);
        });
    }
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ğŸ§¸ ì˜ì–´ ìˆ˜ì—… ë™ì˜ìƒ ë§í¬ ê´€ë¦¬</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #f0f9ff; padding: 40px 20px; display: flex; justify-content: center; color: #444; }
        .container { width: 100%; max-width: 1100px; background: white; padding: 35px; border-radius: 30px; box-shadow: 0 10px 30px rgba(135, 206, 235, 0.2); border: 3px solid #e0f2fe; }
        h1 { text-align: center; color: #60a5fa; font-size: 2rem; margin-bottom: 30px; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: #f0f9ff; padding: 15px 25px; border-radius: 20px; }
        .input-group { display: grid; grid-template-columns: 1fr 1fr 1.5fr 2fr auto; gap: 12px; margin-bottom: 30px; }
        input, select { padding: 12px; border: 2px solid #e0f2fe; border-radius: 15px; outline: none; transition: border 0.3s; }
        input:focus, select:focus { border-color: #87CEEB; }
        button { padding: 10px 18px; border: none; border-radius: 15px; cursor: pointer; font-weight: bold; transition: all 0.2s; }
        .add-btn { background: #87CEEB; color: white; box-shadow: 0 4px 0 #6eb9d9; }
        .add-btn:active { transform: translateY(3px); box-shadow: 0 1px 0 #6eb9d9; }
        .edit-btn { background: #ffed9e; color: #856404; }
        .delete-btn { background: #ffcfcf; color: #a94442; }
        .save-btn { background: #bbf7d0; color: #166534; }
        button:hover { filter: brightness(1.05); transform: scale(1.02); }
        table { width: 100%; border-collapse: separate; border-spacing: 0 10px; table-layout: fixed; }
        th { background: #87CEEB; color: white; padding: 15px; font-size: 1rem; text-align: center; }
        th:first-child { border-radius: 15px 0 0 15px; }
        th:last-child { border-radius: 0 15px 15px 0; }
        td { background: #fff; padding: 15px; text-align: center; border-top: 1px solid #f0f9ff; border-bottom: 1px solid #f0f9ff; word-break: break-all; }
        td:first-child { border-left: 1px solid #f0f9ff; border-radius: 15px 0 0 15px; }
        td:last-child { border-right: 1px solid #f0f9ff; border-radius: 0 15px 15px 0; }
        tr:not(thead tr):hover td { background-color: #f8fdff; transform: scale(1.005); transition: 0.2s; }
        .user-tag { background: #dcfce7; color: #166534; padding: 5px 12px; border-radius: 20px; font-size: 0.85rem; }
        .done-row td { color: #cbd5e1; background: #fcfdfe !important; }
        .done-row a { color: #cbd5e1; text-decoration: line-through; }
        a { color: #3b82f6; text-decoration: none; font-weight: 500; }
        input[type="checkbox"] { transform: scale(1.5); cursor: pointer; accent-color: #87CEEB; }
    </style>
</head>
<body>

<div class="container">
    <h1>â˜ï¸ ì˜ì–´ ìˆ˜ì—… ë™ì˜ìƒ ë§í¬ ê´€ë¦¬</h1>

    <div class="top-bar">
        <strong>ğŸ¿ ëˆ„êµ¬ì˜ ìˆ˜ì—…ì„ ë³¼ê¹Œìš”?</strong>
        <select id="user-filter" onchange="renderLinks(allDataCache)">
            <option value="ì „ì²´">ì „ì²´ ì¹œêµ¬ë“¤</option>
            <option value="í™©ë‹¤ì—°">í™©ë‹¤ì—°</option>
            <option value="ê¹€ë³´ì„">ê¹€ë³´ì„</option>
        </select>
    </div>

    <div class="input-group">
        <select id="new-user">
            <option value="">ì´ë¦„ ì„ íƒ</option>
            <option value="í™©ë‹¤ì—°">í™©ë‹¤ì—°</option>
            <option value="ê¹€ë³´ì„">ê¹€ë³´ì„</option>
        </select>
        <input type="date" id="new-date">
        <input type="text" id="new-title" placeholder="ìˆ˜ì—… ì œëª© ì™ì™">
        <input type="text" id="new-url" placeholder="ë§í¬ ì£¼ì†Œ ë¶™ì—¬ë„£ê¸°">
        <button class="add-btn" onclick="addLink()">ê¸°ë¡í•˜ê¸°</button>
    </div>

    <table>
        <thead>
            <tr>
                <th style="width: 100px;">ì‘ì„±ì</th>
                <th style="width: 125px;">ì–¸ì œì¼ê¹Œ?</th>
                <th style="width: 170px;">ìˆ˜ì—…ì´ë¦„</th>
                <th>ì£¼ì†Œ</th>
                <th style="width: 60px;">ì™„ë£Œ</th>
                <th style="width: 150px;">ì™„ë£Œì‹œê°„</th>
                <th style="width: 140px;">ê´€ë¦¬</th>
            </tr>
        </thead>
        <tbody id="link-table-body">
            <tr><td colspan="7">ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”... ğŸ§¸</td></tr>
        </tbody>
    </table>
</div>

<script>
    const firebaseConfig = {
  apiKey: "AIzaSyAHvOrb4B3c1uY7WwaR1yuQrwP5lDbRZiI",
  authDomain: "linkmanage-d8efd.firebaseapp.com",
  databaseURL: "https://linkmanage-d8efd-default-rtdb.firebaseio.com",
  projectId: "linkmanage-d8efd",
  storageBucket: "linkmanage-d8efd.firebasestorage.app",
  messagingSenderId: "517672204798",
  appId: "1:517672204798:web:ec8315e84a5120648868af",
  measurementId: "G-6J7VGJ2CXM"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let allDataCache = null;
    let editId = null;

    // ë°ì´í„°ë² ì´ìŠ¤ ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ (ë°ì´í„° ë³€ê²½ ì‹œ ìë™ renderLinks í˜¸ì¶œ)
    db.ref('class_links').on('value', (snapshot) => {
        allDataCache = snapshot.val();
        renderLinks(allDataCache); 
    });

    function addLink() {
        const user = document.getElementById('new-user').value;
        const date = document.getElementById('new-date').value;
        const title = document.getElementById('new-title').value;
        const url = document.getElementById('new-url').value;

        if (!user || !date || !title || !url) { alert("ë¹ˆì¹¸ì„ ëª¨ë‘ ì±„ì›Œì£¼ì„¸ìš”! âœ¨"); return; }

        const newRef = db.ref('class_links').push();
        newRef.set({ id: newRef.key, user, date, title, url, checked: false, doneTime: '-' })
        .then(() => {
            document.getElementById('new-title').value = '';
            document.getElementById('new-url').value = '';
        });
    }

    function toggleCheck(id, currentStatus) {
        const now = new Date();
        const timeStr = !currentStatus ? `${now.getMonth()+1}/${now.getDate()} ${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')}` : '-';
        db.ref('class_links/' + id).update({ checked: !currentStatus, doneTime: timeStr });
    }

    function startEdit(id) { 
        editId = id; 
        renderLinks(allDataCache); // ìˆ˜ì • ëª¨ë“œ UIë¡œ ì „í™˜
    }

    // [í•µì‹¬ ìˆ˜ì •] ì €ì¥ í›„ ì¦‰ì‹œ ì¬ì¡°íšŒ ë¡œì§
function saveEdit(id) {
    console.log("ì €ì¥ í”„ë¡œì„¸ìŠ¤ ì‹œì‘: ", id); // ë””ë²„ê¹…ìš©
    
    const row = document.getElementById(`row-${id}`);
    const newDate = row.querySelector('.edit-date').value;
    const newTitle = row.querySelector('.edit-title').value;
    const newUrl = row.querySelector('.edit-url').value;

    const updateData = {
        date: newDate,
        title: newTitle,
        url: newUrl
    };

    // 1. í•´ë‹¹ IDì˜ ê²½ë¡œë¡œ ì§ì ‘ ì—…ë°ì´íŠ¸ ìš”ì²­
    db.ref('class_links/' + id).update(updateData)
    .then(() => { 
        console.log("Firebase ì €ì¥ ì„±ê³µ!");
        editId = null; // ìˆ˜ì • ëª¨ë“œ í•´ì œ

        // 2. ê°•ì œ ì¬ì¡°íšŒ: Firebase ì„œë²„ì—ì„œ ìµœì‹  ë°ì´í„°ë¥¼ í•œ ë²ˆ ë” ê°€ì ¸ì™€ì„œ í™”ë©´ ê°±ì‹ 
        return db.ref('class_links').once('value');
    })
    .then((snapshot) => {
        allDataCache = snapshot.val(); // ìºì‹œ ì—…ë°ì´íŠ¸
        renderLinks(allDataCache);     // í™”ë©´ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
        alert("ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆì–´ìš”! âœ¨");
    })
    .catch(err => {
        console.error("ì €ì¥ ì¤‘ ì—ëŸ¬ ë°œìƒ:", err);
        alert("ì €ì¥ì— ì‹¤íŒ¨í–ˆì–´ìš”. ì¸í„°ë„· ì—°ê²°ì´ë‚˜ Firebase ê¶Œí•œì„ í™•ì¸í•´ ì£¼ì„¸ìš”.");
    });
}
    function deleteLink(id) { 
        if(confirm("ì´ ê¸°ë¡ì„ ì§€ìš¸ê¹Œìš”? ğŸ’¨")) { 
            db.ref('class_links/' + id).remove(); 
        } 
    }

    function renderLinks(data) {
        const tbody = document.getElementById('link-table-body');
        const filter = document.getElementById('user-filter').value;
        tbody.innerHTML = '';
        
        if(!data) { 
            tbody.innerHTML = '<tr><td colspan="7">ì•„ì§ ë“±ë¡ëœ ìˆ˜ì—…ì´ ì—†ì–´ìš”! ğŸŒ¸</td></tr>'; 
            return; 
        }

        Object.values(data).sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(link => {
            if (filter !== "ì „ì²´" && link.user !== filter) return;

            const tr = document.createElement('tr');
            tr.id = `row-${link.id}`;
            if(link.checked) tr.className = 'done-row';

            if(editId === link.id) {
                // ìˆ˜ì • ì…ë ¥ ëª¨ë“œ
                tr.innerHTML = `
                    <td><span class="user-tag">${link.user}</span></td>
                    <td><input type="date" class="edit-date" value="${link.date}" style="width:110px"></td>
                    <td><input type="text" class="edit-title" value="${link.title}" style="width:130px"></td>
                    <td><input type="text" class="edit-url" value="${link.url}" style="width:90%"></td>
                    <td>-</td><td>${link.doneTime}</td>
                    <td><button class="save-btn" onclick="saveEdit('${link.id}')">ê¾¹ ì €ì¥</button></td>
                `;
            } else {
                // ì¼ë°˜ ë³´ê¸° ëª¨ë“œ
                tr.innerHTML = `
                    <td><span class="user-tag">${link.user}</span></td>
                    <td>${link.date}</td>
                    <td><strong>${link.title}</strong></td>
                    <td><a href="${link.url}" target="_blank">ë³´ëŸ¬ê°€ê¸° âœˆï¸</a></td>
                    <td><input type="checkbox" ${link.checked ? 'checked' : ''} onchange="toggleCheck('${link.id}', ${link.checked})"></td>
                    <td style="font-size:0.8rem;">${link.doneTime}</td>
                    <td>
                        <button class="edit-btn" onclick="startEdit('${link.id}')">ìˆ˜ì •</button>
                        <button class="delete-btn" onclick="deleteLink('${link.id}')">ì‚­ì œ</button>
                    </td>
                `;
            }
            tbody.appendChild(tr);
        });
    }
</script>
</body>
</html>